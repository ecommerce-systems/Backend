# 검색 성능 최적화 및 리팩토링 보고서

## 1. 개요
본 문서는 상품 검색 기능의 성능 병목 현상을 해결하기 위해 적용된 최적화 전략과 그에 따른 성능 개선 효과를 기술한다.  
k6 부하 테스트를 통해 **기존 정규화된 DB 구조 기반 검색(v1)**과 **역정규화된 검색 전용 테이블 기반 검색(v2)**을 비교 분석하였다.

## 2. 기존 문제점 및 해결 솔루션

### 2.1. 주요 문제점 (V1 Legacy)
*   **과도한 JOIN 연산**: `Product` 엔티티가 11개 이상의 테이블과 관계를 맺고 있어, 단순 검색 시에도 복잡한 JOIN 발생.
*   **풀 테이블 스캔 (Full Table Scan)**: `LIKE %keyword%` (Infix) 검색으로 인해 인덱스 미적용 및 스캔 효율 저하.
*   **느린 필터링**: 다중 카테고리 필터링 시 JOIN된 테이블 전체를 확인해야 하므로 응답 지연.

### 2.2. 해결 솔루션 (V2 Optimized)
*   **역정규화 (Denormalization)**: `ProductSearch` 단일 테이블(Flat Table)을 도입하여 **JOIN 연산 완전 제거**.
*   **인덱싱 전략**: `prod_name` 및 주요 필터링 컬럼에 B-Tree 인덱스 및 개별 인덱스 적용.
*   **하이브리드 검색**: `LIKE 'keyword%'` (Prefix, 인덱스 활용) 우선 수행 후, 필요시 보완 검색 수행.
*   **데이터 동기화**: `ProductService` 트랜잭션 내에서 원본(V1)과 검색용(V2) 데이터 실시간 동기화.

## 3. 테스트 환경
- **기존 검색 (v1)**: JOIN 기반 조회, Infix 검색
- **최적화 검색 (v2)**: 단일 테이블 조회, Prefix 우선 검색, 멀티 필터링
- **테스트 시나리오**: 상품 생성 → 단일 조회 → 수정 → 삭제 / 사용자 키워드 검색 및 필터 검색
- **부하 조건**: VUs 200, Duration 30초

## 4. 결과 요약

| 항목 | 기존 검색 (v1) | 최적화 검색 (v2) |
|------|--------------|-----------------|
| 총 요청 수 (http_reqs) | 6,210 (163.11/s) | **11,100 (325.70/s)** |
| 성공률 (checks_succeeded) | 100% | 100% |
| 평균 응답 시간 (http_req_duration) | 908.52ms | **381.82ms** |
| 중앙값 응답 시간 (Median) | 719.81ms | **233.22ms** |
| 최대 응답 시간 (max) | 5.18s | **2.54s** |
| 90% 응답 시간 (p90) | 2.11s | **916.87ms** |
| 95% 응답 시간 (p95) | 2.57s | **1.09s** |
| Iteration 평균 시간 | 11.08s | **5.82s** |
| 데이터 수신량 (Network In) | 1.1 GB (29 MB/s) | **8.3 MB (245 kB/s)** |

## 5. 성능 향상 포인트
- **처리율(Throughput) 2배 증가**: 초당 처리 요청 수가 163건에서 325건으로 약 **100% 향상**되었다.
- **응답 속도 획기적 단축**: 
  - 평균 응답 시간이 **58% 감소** (908ms → 381ms)하였다.
  - 특히 중앙값(Median)은 **67% 감소** (719ms → 233ms)하여 대다수 사용자에게 쾌적한 경험을 제공한다.
- **네트워크 효율성 극대화**: 불필요한 전체 데이터 조회를 최적화된 검색 결과로 대체하여 데이터 수신량을 1.1GB에서 8.3MB로 **99% 이상 절감**하였다.

## 6. 트레이드 오프
- **데이터 중복 저장**: 읽기 성능을 위해 데이터를 중복 저장하므로 스토리지 사용량이 증가한다.
- **정합성 관리 비용**: 상품 정보 변경 시 V1과 V2 테이블 간의 동기화 로직이 필수적이며, 이를 위한 개발 및 유지보수 비용이 발생한다.
- **쓰기 지연**: 생성/수정 시 두 번의 쓰기 작업이 발생하므로 미세한 쓰기 지연이 있을 수 있으나, 읽기 성능 이점이 이를 상회한다.

## 7. 결론
역정규화와 인덱싱 최적화를 적용한 **V2 검색 엔진**은 V1 대비 **2배 이상의 처리량**과 **3배 가까운 응답 속도 개선**을 보여주었다.  
특히 대규모 트래픽 상황에서도 안정적인 응답 속도(P95 1초대 유지)를 보장하므로, 메인 상품 검색 서비스로 V2를 전면 도입하는 것이 타당하다.

## 8. 산출물
### 아키텍처 비교도
[architecture_comparison.puml](architecture_comparison.puml)


### 동기화 로직 시퀀스