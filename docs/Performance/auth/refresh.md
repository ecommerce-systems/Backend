# 성능 향상 분석 보고서

## 개요
본 문서는 k6 부하 테스트를 통해 **DB 기반 인증(v1)**과 **Redis 기반 인증(v2)**을 비교하여 성능 향상 효과를 분석한 결과를 담고 있다.
테스트는 두 가지 관점에서 진행되었다:
1. **전체 사용자 흐름(User Journey)**: 회원가입부터 탈퇴까지의 일반적인 시나리오
2. **Refresh Token 성능 심층 분석**: 서버 부하의 핵심인 토큰 갱신 로직 집중 테스트

---

## 1. 전체 사용자 흐름 (User Journey) 테스트
* **테스트 스크립트**: `auth-test.js` (회원가입 → 로그인 → 토큰 갱신 → 로그아웃 → 탈퇴)
* **VUs**: 200, **Duration**: 10초

### 결과 요약

| 항목 | DB 인증 (v1) | Redis 인증 (v2) |
|------|--------------|-----------------|
| 총 요청 수 (http_reqs) | 2400 (150.67/s) | 2400 (94.41/s) |
| 성공률 (checks_succeeded) | 100% (2400/2400) | 100% (2400/2400) |
| 평균 응답 시간 (avg) | 366.27ms | **341.3ms** |
| 중앙값 응답 시간 (med) | 251.08ms | **215.76ms** |
| 95% 응답 시간 (p95) | 1.01s | **993ms** |
| Iteration 평균 시간 | 7.2s | **7.05s** |

### 분석
* Redis 환경이 전체적인 응답 속도에서 약 **7~10% 성능 우위**를 보임.
* 일반적인 API 호출(Access Token 검증)은 메모리(JWT Signature)에서 처리되므로 차이가 크지 않음.

---

## 2. Refresh Token 성능 심층 분석 (핵심 병목 구간)
* **테스트 목적**: 실제 DB I/O가 발생하는 **토큰 갱신(Refresh)** 단계의 병목 현상 규명
* **테스트 스크립트**: `refresh.js` (로그인 직후 고속 Refresh 요청)
* **VUs**: 200, **Duration**: 10초

### 📊 상세 비교 결과

| 측정 항목 | DB 기반 (V1) | Redis 기반 (V2) | 성능 향상 (V2 vs V1) |
| :--- | :--- | :--- | :--- |
| **평균 응답 속도 (Avg)** | 29.55ms | **9.07ms** | 🚀 **3.2배 빠름** |
| **중앙값 (Median)** | 18ms | **6ms** | **3배 빠름** |
| **상위 95% 지연 (p95)** | 100ms | **25ms** | ⚡ **4배 더 안정적** |
| **최대 지연 (Max)** | 196ms | **96ms** | **스파이크 방어 우수** |
| **에러율 (Error Rate)** | **0.64% (실패 발생)** | **0.00% (완벽 성공)** | **데이터 정합성 보장** |

### 🚨 V1(DB) 실패 원인 분석 (Race Condition)
테스트 도중 V1에서만 간헐적으로 `401 Unauthorized` 에러가 발생함.
* **원인**: 고부하 상황에서 **DB 트랜잭션 커밋(Insert)이 지연**되는 동안, k6가 즉시 Refresh 요청(Select)을 보냄.
* **현상**: DB에 아직 토큰 데이터가 저장되지 않은 상태에서 조회가 일어나 **"Token Not Found"** 처리됨.
* **의미**: RDB를 세션 저장소로 사용할 경우, **물리적 Disk I/O 한계로 인해 트랜잭션 지연 및 데이터 불일치**가 발생할 수 있음을 증명.

### ✅ 결론
Redis 기반 인증(V2)은 단순 속도 향상뿐만 아니라, **고부하 트래픽에서의 데이터 정합성과 트랜잭션 안정성**을 완벽하게 보장한다.
특히 **p95(상위 5% 지연)가 4배나 감소**했다는 점은 사용자 경험(UX) 측면에서 매우 중요한 개선점이다.

---

## 트레이드 오프
- **Redis (V2)**:
    - **장점**: 압도적인 속도(메모리), 싱글 스레드 구조로 동시성 문제 해결, TTL 자동 만료 지원.
    - **단점**: 메모리 비용 발생, 영속성 관리가 필요할 수 있음(단, Refresh Token은 휘발성이라 문제없음).
- **DB (V1)**:
    - **장점**: 추가 인프라 없이 구현 가능, 강력한 영속성.
    - **단점**: Disk I/O 병목으로 인한 성능 저하, 고부하 시 트랜잭션 지연 발생 가능성 높음.

---
